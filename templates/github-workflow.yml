name: Plugin Review & Validation

on:
  pull_request:
    paths: 
      - 'community/**'
      - 'official/**'
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # 1. åŸºç¡€æ£€æŸ¥
  basic-validation:
    name: Basic Validation
    runs-on: ubuntu-latest
    outputs:
      plugin-path: ${{ steps.detect.outputs.plugin-path }}
      plugin-name: ${{ steps.detect.outputs.plugin-name }}
      security-level: ${{ steps.detect.outputs.security-level }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect Plugin Changes
        id: detect
        run: |
          # æ£€æµ‹å˜æ›´çš„æ’ä»¶ç›®å½•
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          PLUGIN_PATH=$(echo "$CHANGED_FILES" | grep -E '^(community|official)/' | head -1 | cut -d'/' -f1-2)
          
          if [ -z "$PLUGIN_PATH" ]; then
            echo "No plugin changes detected"
            exit 1
          fi
          
          PLUGIN_NAME=$(basename "$PLUGIN_PATH")
          echo "plugin-path=$PLUGIN_PATH" >> $GITHUB_OUTPUT
          echo "plugin-name=$PLUGIN_NAME" >> $GITHUB_OUTPUT
          
          # è¯»å–å®‰å…¨ç­‰çº§
          if [ -f "$PLUGIN_PATH/plugin.registry.json" ]; then
            SECURITY_LEVEL=$(jq -r '.security.level // "standard"' "$PLUGIN_PATH/plugin.registry.json")
            echo "security-level=$SECURITY_LEVEL" >> $GITHUB_OUTPUT
          else
            echo "security-level=standard" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate Plugin Structure
        run: |
          PLUGIN_PATH="${{ steps.detect.outputs.plugin-path }}"
          
          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
          required_files=(
            "package.json"
            "plugin.manifest.json" 
            "plugin.registry.json"
            "src/index.ts"
            "README.md"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$PLUGIN_PATH/$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done
      
      - name: Validate Manifest
        run: |
          PLUGIN_PATH="${{ steps.detect.outputs.plugin-path }}"
          
          # éªŒè¯ manifest æ ¼å¼
          if ! jq empty "$PLUGIN_PATH/plugin.manifest.json"; then
            echo "âŒ Invalid JSON in plugin.manifest.json"
            exit 1
          fi
          
          # æ£€æŸ¥å¿…éœ€å­—æ®µ
          required_fields=("name" "version" "author" "nodeType" "category")
          for field in "${required_fields[@]}"; do
            if [ "$(jq -r ".$field // empty" "$PLUGIN_PATH/plugin.manifest.json")" = "" ]; then
              echo "âŒ Missing required field in manifest: $field"
              exit 1
            fi
          done
          
          echo "âœ… Manifest validation passed"

  # 2. ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: basic-validation
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Install Dependencies
        run: |
          cd ${{ needs.basic-validation.outputs.plugin-path }}
          pnpm install
      
      - name: Lint Check
        run: |
          cd ${{ needs.basic-validation.outputs.plugin-path }}
          
          # ESLint æ£€æŸ¥
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            pnpm eslint src/**/*.ts
          fi
          
          # Prettier æ£€æŸ¥
          if [ -f ".prettierrc" ]; then
            pnpm prettier --check src/**/*.ts
          fi
      
      - name: TypeScript Check
        run: |
          cd ${{ needs.basic-validation.outputs.plugin-path }}
          pnpm tsc --noEmit
      
      - name: Unit Tests
        run: |
          cd ${{ needs.basic-validation.outputs.plugin-path }}
          
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            pnpm test
          else
            echo "âš ï¸ No tests found - please add unit tests"
          fi

  # 3. å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: basic-validation
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Dependency Vulnerability Scan
        run: |
          cd ${{ needs.basic-validation.outputs.plugin-path }}
          
          # npm audit
          npm audit --audit-level=moderate || true
          
          # æ£€æŸ¥å·²çŸ¥æ¶æ„åŒ…
          echo "Checking for malicious packages..."
          
      - name: Code Security Scan
        run: |
          cd ${{ needs.basic-validation.outputs.plugin-path }}
          
          # æ£€æŸ¥æ½œåœ¨å®‰å…¨é—®é¢˜
          echo "Scanning for security issues..."
          
          # æ£€æŸ¥å±é™©å‡½æ•°è°ƒç”¨
          if grep -r "eval\|Function\|execSync\|spawn" src/; then
            echo "âš ï¸ Found potentially dangerous function calls"
            echo "Please review and ensure they are used safely"
          fi
          
          # æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿè®¿é—®
          if grep -r "fs\.\|readFile\|writeFile\|unlink" src/; then
            echo "âš ï¸ Found file system access"
            echo "Ensure proper permissions are declared"
          fi
          
          # æ£€æŸ¥ç½‘ç»œè¯·æ±‚
          if grep -r "fetch\|axios\|request\|http\." src/; then
            echo "âš ï¸ Found network requests"
            echo "Ensure proper permissions are declared"
          fi

  # 4. åŠŸèƒ½æµ‹è¯•
  functional-test:
    name: Functional Test
    runs-on: ubuntu-latest
    needs: [basic-validation, code-quality]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: Build Plugin
        run: |
          cd ${{ needs.basic-validation.outputs.plugin-path }}
          pnpm install
          pnpm build
      
      - name: Plugin SDK Validation
        run: |
          cd ${{ needs.basic-validation.outputs.plugin-path }}
          
          # ä½¿ç”¨ plugin-sdk éªŒè¯
          npx automation-plugin-sdk validate .
      
      - name: Integration Test
        run: |
          cd ${{ needs.basic-validation.outputs.plugin-path }}
          
          # æ¨¡æ‹Ÿæ’ä»¶åŠ è½½æµ‹è¯•
          node -e "
            const plugin = require('./dist/index.js');
            const manifest = plugin.default?.getManifest?.();
            
            if (!manifest) {
              console.error('âŒ Plugin does not export valid manifest');
              process.exit(1);
            }
            
            console.log('âœ… Plugin loaded successfully');
            console.log('Plugin:', manifest.name, 'v' + manifest.version);
          "

  # 5. å®‰å…¨ç­‰çº§æ£€æŸ¥
  security-level-check:
    name: Security Level Check
    runs-on: ubuntu-latest
    needs: [basic-validation, security-scan]
    if: needs.basic-validation.outputs.security-level != 'standard'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Enhanced Security Review
        run: |
          SECURITY_LEVEL="${{ needs.basic-validation.outputs.security-level }}"
          PLUGIN_PATH="${{ needs.basic-validation.outputs.plugin-path }}"
          
          echo "ğŸ” Enhanced security review for $SECURITY_LEVEL level plugin"
          
          case $SECURITY_LEVEL in
            "elevated")
              echo "ğŸ”¶ Elevated security checks..."
              # æ£€æŸ¥æƒé™å£°æ˜
              # éªŒè¯æ•æ„Ÿ API ä½¿ç”¨
              ;;
            "system")
              echo "ğŸ”´ System-level security checks..."
              # æ·±åº¦å®‰å…¨æ‰«æ
              # éœ€è¦äººå·¥å®¡æ ¸
              echo "âš ï¸ System-level plugins require manual security review"
              ;;
          esac
      
      - name: Request Manual Review
        if: needs.basic-validation.outputs.security-level == 'system'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ”´ **System-level plugin detected**
              
              This plugin requires manual security review due to its system-level permissions.
              
              **Security Level**: \`${{ needs.basic-validation.outputs.security-level }}\`
              **Plugin**: \`${{ needs.basic-validation.outputs.plugin-name }}\`
              
              A security team member will review this plugin within 7-14 business days.
              
              **Required Reviews:**
              - [ ] Code security audit
              - [ ] Permission validation  
              - [ ] Penetration testing
              - [ ] Compliance check
              `
            })

  # 6. è‡ªåŠ¨åŒ–ç»“æœæ±‡æ€»
  review-summary:
    name: Review Summary
    runs-on: ubuntu-latest
    needs: [basic-validation, code-quality, security-scan, functional-test]
    if: always()
    
    steps:
      - name: Generate Review Summary
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              basic: '${{ needs.basic-validation.result }}',
              quality: '${{ needs.code-quality.result }}', 
              security: '${{ needs.security-scan.result }}',
              functional: '${{ needs.functional-test.result }}'
            };
            
            const passed = Object.values(results).every(r => r === 'success');
            const emoji = passed ? 'âœ…' : 'âŒ';
            const status = passed ? 'PASSED' : 'FAILED';
            
            const summary = `## ${emoji} Plugin Review ${status}
            
            **Plugin**: \`${{ needs.basic-validation.outputs.plugin-name }}\`
            **Security Level**: \`${{ needs.basic-validation.outputs.security-level }}\`
            
            ### Check Results
            - **Basic Validation**: ${results.basic === 'success' ? 'âœ…' : 'âŒ'} ${results.basic}
            - **Code Quality**: ${results.quality === 'success' ? 'âœ…' : 'âŒ'} ${results.quality}  
            - **Security Scan**: ${results.security === 'success' ? 'âœ…' : 'âŒ'} ${results.security}
            - **Functional Test**: ${results.functional === 'success' ? 'âœ…' : 'âŒ'} ${results.functional}
            
            ${passed 
              ? 'ğŸ‰ **All automated checks passed!** This plugin is ready for manual review.' 
              : 'âš ï¸ **Some checks failed.** Please review the failing jobs and fix the issues.'}
            
            ### Next Steps
            ${passed 
              ? `- Manual code review by maintainers
              - Final approval and merge
              - Automatic deployment to plugin registry` 
              : `- Fix the failing checks
              - Push updates to trigger re-validation`}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            }); 